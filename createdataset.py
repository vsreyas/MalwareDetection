import os
import  pandas as pd
import numpy as np
import pcaper

def createDataset(main_dir,directory, dcsv, catalog_dir,y = 1):

    pcap_parser = pcaper.PcapParser()
    
    dir_list = os.listdir(main_dir)
    
    i = 0
    names = ['Malware','Class']

    df = pd.read_csv(catalog_dir, header = 0, names=names)

    for file in dir_list:
        source = os.path.join(main_dir, file)
        params = {
        'input': source
        }

        file_split = file.split("_")

        if y == -1:y = df.loc[lambda df: ("M"+ df['Malware'] )== file_split[1], 'Class']


        for request in pcap_parser.read_pcap(params):
            if(i>4) : y = 0
            dest = os.path.join(directory,'http'+str(i)+'.txt')
            f1 = open(dest,'w')
            f1.write("Class "+str(y)+" ")
            request_list = request.origin.split("\n")
            counter = "Class "+str(y)+"\n"
            for each in request_list:
                curr = each
                rep = [',',';',':','/','?','=','(',')','{','}','the','is','were','  ']
                for r in rep:
                    curr = curr.replace(r,' ')
                common = ['.jpg','.png','.gif','.js','.css']
                new = curr.split()
                for check in common:
                    for word in new:
                        k = word.find(check)
                        if k >= 0: new.remove(word)
                
                new.append('\n')
                new = ' '.join(new)
                counter = counter + new
                f1.write(new)
            counter = counter.split()
            df1 = pd.value_counts(np.array(counter), normalize=True)
            count = df1.T.to_dict()
            c = os.path.join(dcsv,'http_c'+str(i)+'.csv')
            df1.to_csv(c)
            f1.close()
            i = i + 1
    
    return directory, dcsv

""" main_dir = "/home/venky/Documents/IITM Dec/Malware detection using N Grams and SVM/MalDetHTTP/data_p"
direc = "/home/venky/Documents/IITM Dec/Malware detection using N Grams and SVM/MalDetHTTP/trial"
catalog = "/home/venky/Documents/IITM Dec/Malware detection using N Grams and SVM/MalDetHTTP/Processed Labels.csv"
createDataset(main_dir,direc,direc,catalog)
 """





        

        

            